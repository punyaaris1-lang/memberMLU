<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MLU Super App</title>
    
    <script>
        const CFG = {
            sheetID: '1kp7bHdgSTTNZF3uyd1ul-LnTZVjuLs1TVQnRxoViPfQ', 
            monkeyURL: 'https://api.sheetmonkey.io/form/h12GBnHqFk6zUJDgH9qmn2',
            waAdmin: '6285691536957'
        };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- TEMA HIGH-TECH --- */
        :root {
            --primary: #00f2ff; /* Cyan Neon */
            --secondary: #0066ff; /* Biru Tua */
            --bg-dark: #0a0a0a;
            --panel-bg: rgba(10, 15, 20, 0.95);
            --text: #e0e0e0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Exo 2', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text); 
            height: 100vh; overflow: hidden; 
        }

        /* BACKGROUND */
        body::before {
            content: ""; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            background: url('https://i.ibb.co.com/4ZL4bhGR/1763994565752.png') no-repeat center center;
            background-size: 80%; opacity: 0.08; z-index: -1; filter: grayscale(100%);
        }

        .app-container { height: 100%; overflow-y: auto; padding-bottom: 80px; }
        .hidden { display: none !important; }

        /* TOMBOL & INPUT PRO STYLE */
        input, select { 
            width: 100%; padding: 15px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid #333; border-left: 3px solid var(--primary);
            color: #fff; border-radius: 5px; margin-bottom: 15px; font-size: 16px; outline: none;
        }
        .btn-neon { 
            width: 100%; padding: 15px; 
            background: linear-gradient(90deg, var(--secondary), var(--primary)); 
            color: #000; font-weight: 800; border: none; border-radius: 5px; 
            font-size: 16px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }
        .btn-neon:active { transform: scale(0.98); }

        /* HEADER */
        .header { padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 12px; color: #888; letter-spacing: 2px; }
        .header p { font-size: 20px; font-weight: 700; color: var(--primary); }
        .header-logo { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; background: #000; }

        /* DASHBOARD CARDS */
        .vehicle-card { 
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.5) 100%);
            border: 1px solid #333; border-top: 1px solid #555;
            border-radius: 15px; padding: 20px; margin: 0 20px 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .value-big { font-size: 32px; font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        
        /* MAP CONTAINER (FULLSCREEN) */
        #page-map { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; background: #000; display: none; 
        }
        #page-map.active-map { display: block !important; }
        #map { width: 100%; height: 100%; background: #111; }

        /* --- MARKER STYLES --- */
        /* Ikon Motor (Panah Navigasi Glowing) */
        .user-nav-icon {
            width: 20px; height: 20px;
            background: var(--primary);
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 15px var(--primary);
            animation: pulse-nav 1.5s infinite;
        }
        @keyframes pulse-nav { 0% { box-shadow: 0 0 0 0 rgba(0,242,255,0.7); } 70% { box-shadow: 0 0 0 15px rgba(0,242,255,0); } 100% { box-shadow: 0 0 0 0 rgba(0,242,255,0); } }

        /* Ikon FC (Petir Solid) */
        .fc-icon-wrap {
            font-size: 24px; color: #ffd700; 
            filter: drop-shadow(0 0 5px #ffd700);
            text-align: center;
        }
        .fc-label {
            font-size: 10px; background: rgba(0,0,0,0.7); color: #fff;
            padding: 2px 4px; border-radius: 3px; border: 1px solid #555;
            white-space: nowrap; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%);
        }

        /* OVERLAY INFO PANEL */
        .map-panel {
            position: absolute; bottom: 90px; left: 15px; right: 15px;
            background: var(--panel-bg); border-top: 2px solid var(--primary);
            border-radius: 15px; padding: 20px; z-index: 999;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px); text-align: left;
        }
        .panel-title { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .panel-info { display: flex; gap: 15px; color: #aaa; font-size: 12px; margin-bottom: 15px; }
        .panel-info span i { color: var(--primary); margin-right: 5px; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-start { background: var(--primary); color: #000; }
        .btn-gmaps { background: #333; color: #fff; border: 1px solid #555; }

        /* Route Line Style */
        .leaflet-routing-container { display: none !important; } /* Sembunyikan box teks */
        path.leaflet-interactive { stroke: var(--primary); stroke-width: 6; opacity: 0.8; stroke-linecap: round; }

        /* NAVBAR */
        .navbar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.9); border-top: 1px solid #333; 
            display: flex; justify-content: space-around; align-items: center; 
            padding: 15px 0; z-index: 9999; backdrop-filter: blur(5px);
        }
        .nav-icon { color: #555; font-size: 22px; transition: 0.3s; }
        .nav-icon.active { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        
        /* Pages lain */
        #page-login { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-dark); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:30px; }
        #page-sos { display:none; width:100%; height:100%; }
    </style>
</head>
<body>

    <div id="page-login">
        <img src="https://i.ibb.co.com/4ZL4bhGR/1763994565752.png" style="width:120px; margin-bottom:30px;">
        <div style="width:100%; max-width:350px;">
            <h2 style="color:var(--primary); margin-bottom:5px;">SYSTEM LOGIN</h2>
            <p style="color:#666; margin-bottom:30px; font-size:12px;">Maka Lintas Utara Access</p>
            <input type="tel" id="inputHP" placeholder="Nomor HP Terdaftar">
            <button class="btn-neon" onclick="cekLogin()">CONNECT</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="page-dashboard" class="app-container">
            <div class="header">
                <div>
                    <h1>WELCOME BACK</h1>
                    <p id="disp-nama">User</p>
                </div>
                <img src="https://i.ibb.co.com/4ZL4bhGR/1763994565752.png" class="header-logo" onclick="logout()">
            </div>

            <div class="vehicle-card">
                <span style="color:#888; font-size:10px; letter-spacing:1px;">TAGIHAN HARI INI</span>
                <div class="value-big" id="disp-tagihan">...</div>
                <div style="border-top:1px solid #333; margin-top:15px; padding-top:10px; display:flex; justify-content:space-between;">
                    <span style="color:var(--primary);">MAKA MOTORS</span>
                    <span id="disp-plat" style="background:#222; padding:2px 8px; border-radius:4px; font-size:12px;">...</span>
                </div>
            </div>

            <div style="padding: 0 20px; display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="vehicle-card" style="margin:0; text-align:center;">
                    <i class="far fa-calendar-alt" style="color:#888;"></i>
                    <div style="font-size:14px; margin-top:5px;" id="disp-join">...</div>
                </div>
                <div class="vehicle-card" style="margin:0; text-align:center;" onclick="bukaMenuMakaPlus()">
                    <i class="fas fa-bolt" id="icon-maka" style="color:#888;"></i>
                    <div style="font-size:14px; margin-top:5px;" id="disp-maka-status">...</div>
                </div>
            </div>
        </div>

        <div id="page-map">
            <div id="map"></div>
            
            <div id="map-panel" class="map-panel" style="display:none;">
                <div class="panel-title" id="panel-name">Nama Lokasi</div>
                <div class="panel-info">
                    <span id="info-dist"><i class="fas fa-road"></i> 0 km</span>
                    <span id="info-time"><i class="far fa-clock"></i> 0 mnt</span>
                    <span id="info-batt"><i class="fas fa-battery-half"></i> -0%</span>
                </div>
                <div class="btn-group">
                    <button class="btn-action btn-start" onclick="startRoute()"><i class="fas fa-location-arrow"></i> MULAI JALAN</button>
                    <button class="btn-action btn-gmaps" onclick="openGmaps()"><i class="fas fa-map"></i> GMAPS</button>
                </div>
            </div>

            <div onclick="centerGPS()" style="position:absolute; bottom:100px; right:15px; width:45px; height:45px; background:#000; border:2px solid var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; z-index:999; box-shadow:0 0 15px rgba(0,242,255,0.3);">
                <i class="fas fa-crosshairs" style="color:var(--primary);"></i>
            </div>
        </div>

        <div class="navbar">
            <div class="nav-icon active" onclick="switchPage('dashboard')"><i class="fas fa-home"></i></div>
            <div onclick="switchPage('map')" style="background:#000; border:2px solid var(--primary); width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-top:-30px; box-shadow:0 0 20px rgba(0,242,255,0.3); transition:0.3s;">
                <i class="fas fa-map-marked-alt" style="color:var(--primary); font-size:24px;"></i>
            </div>
            <div class="nav-icon" onclick="alert('Menu Profile')"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <script>
        const CFG = {
            sheetID: '1kp7bHdgSTTNZF3uyd1ul-LnTZVjuLs1TVQnRxoViPfQ', 
            waAdmin: '6285691536957'
        };

        let map, userMarker, routingControl, selectedFC;
        let userLat = null, userLng = null;

        // --- INIT ---
        window.onload = () => {
            if(localStorage.getItem('userHP')) cekLogin(localStorage.getItem('userHP'), true);
        };

        // --- LOGIN ---
        function cekLogin(savedHP = null, isAuto = false) {
            const hp = savedHP || document.getElementById('inputHP').value.replace(/[^0-9]/g,'').replace(/^62/,'').replace(/^0/,'');
            if(!hp) return alert("Isi Nomor HP");
            
            const btn = document.querySelector('#page-login button');
            if(!isAuto) { btn.innerText = "CONNECTING..."; btn.disabled = true; }

            fetch(`https://opensheet.elk.sh/${CFG.sheetID}/USER?t=${Date.now()}`)
            .then(r => r.json())
            .then(data => {
                const user = data.find(u => String(u['No HP']).includes(hp));
                if(user) {
                    localStorage.setItem('userHP', hp);
                    loadUI(user);
                } else {
                    if(isAuto) { localStorage.clear(); location.reload(); }
                    else { alert("Nomor tidak terdaftar."); btn.innerText = "LOGIN"; btn.disabled = false; }
                }
            }).catch(() => { alert("Gagal Koneksi"); btn.disabled = false; });
        }

        function loadUI(user) {
            document.getElementById('disp-nama').innerText = user['Nama'];
            document.getElementById('disp-plat').innerText = user['Plat Nomor'];
            document.getElementById('disp-join').innerText = user['Tanggal Join'] || "-";
            
            // Hitung Tagihan
            const isMaka = String(user['Maka Plus']).toUpperCase().includes("YA") || localStorage.getItem('makaLocal');
            let price = 70000; if(isMaka) price += 10000;
            const tgl = new Date().getDate();
            if([14, 28, 31].includes(tgl)) {
                document.getElementById('disp-tagihan').innerText = "LIBUR";
                document.getElementById('disp-tagihan').style.color = "#0f0";
            } else {
                document.getElementById('disp-tagihan').innerText = "Rp " + price.toLocaleString('id-ID');
            }
            
            document.getElementById('disp-maka-status').innerText = isMaka ? "AKTIF" : "NON";
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            setTimeout(initMap, 1000); // Siapkan peta di background
        }

        // --- MAP ENGINE (LEAFLET + OSRM) ---
        function switchPage(page) {
            document.getElementById('page-dashboard').classList.add('hidden');
            document.getElementById('page-map').classList.remove('active-map');
            document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));

            if(page === 'dashboard') {
                document.getElementById('page-dashboard').classList.remove('hidden');
                document.querySelector('.nav-icon:nth-child(1)').classList.add('active');
            } 
            else if (page === 'map') {
                document.getElementById('page-map').classList.add('active-map');
                setTimeout(() => {
                    if(!map) initMap();
                    map.invalidateSize(); // FIX BLANK MAP
                }, 200);
            }
        }

        function initMap() {
            if(map) return;
            
            // 1. TAMPILAN PETA GELAP (DARK MATTER)
            map = L.map('map', {zoomControl: false}).setView([-6.2, 106.8], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; MLU Map', maxZoom: 19
            }).addTo(map);
            
            // 2. LOAD DATA FC
            loadFC();

            // 3. TRACK USER
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    
                    if(!userMarker) {
                        // Marker User: Lingkaran Neon Biru
                        const userIcon = L.divIcon({ className: 'custom', html: '<div class="user-nav-icon"></div>', iconSize: [20, 20] });
                        userMarker = L.marker([userLat, userLng], {icon: userIcon}).addTo(map);
                        map.flyTo([userLat, userLng], 14, {duration: 2}); // Animasi Halus
                    } else {
                        userMarker.setLatLng([userLat, userLng]);
                    }
                }, err => console.log(err), {enableHighAccuracy: true});
            }
        }

        function loadFC() {
            fetch(`https://opensheet.elk.sh/${CFG.sheetID}/LOKASI`).then(r=>r.json()).then(data => {
                data.forEach(loc => {
                    let lat = parseFloat(String(loc.lat).replace(',','.'));
                    let lng = parseFloat(String(loc.lng).replace(',','.'));
                    if(!isNaN(lat)) {
                        // Ikon Petir
                        const fcIcon = L.divIcon({ className: 'custom', html: `<div class="fc-icon-wrap"><i class="fas fa-bolt"></i><div class="fc-label">${loc.nama}</div></div>`, iconSize: [30, 50], iconAnchor: [15, 40] });
                        
                        let marker = L.marker([lat, lng], {icon: fcIcon}).addTo(map);
                        
                        // KLIK FC
                        marker.on('click', () => {
                            selectedFC = { lat: lat, lng: lng, ...loc };
                            showPanel(selectedFC);
                        });
                    }
                });
            });
        }

        function showPanel(loc) {
            document.getElementById('map-panel').style.display = 'block';
            document.getElementById('panel-name').innerText = loc.nama;
            
            // Hitung Jarak Lurus (Estimasi Cepat)
            if(userLat) {
                let d = getDist(userLat, userLng, loc.lat, loc.lng);
                document.getElementById('info-dist').innerHTML = `<i class="fas fa-road"></i> ${d.toFixed(1)} km`;
                document.getElementById('info-time').innerHTML = `<i class="far fa-clock"></i> ${Math.ceil(d*3)} mnt`;
                document.getElementById('info-batt').innerHTML = `<i class="fas fa-battery-half"></i> -${Math.ceil(d*1.5)}%`;
            }
        }

        function startRoute() {
            if(!userLat || !selectedFC) return alert("Tunggu sinyal GPS...");
            
            // Hapus rute lama
            if(routingControl) map.removeControl(routingControl);
            
            // GAMBAR JALUR BIRU (OSRM)
            routingControl = L.Routing.control({
                waypoints: [ L.latLng(userLat, userLng), L.latLng(selectedFC.lat, selectedFC.lng) ],
                lineOptions: { styles: [{color: '#00f3ff', opacity: 0.8, weight: 6}] },
                createMarker: function() { return null; }, // Hapus marker default
                addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true
            }).addTo(map);
            
            document.getElementById('map-panel').style.display = 'none'; // Tutup panel biar lega
        }

        function openGmaps() {
            if(selectedFC) window.open(selectedFC.gmap || `https://maps.google.com/?q=${selectedFC.lat},${selectedFC.lng}`, '_blank');
        }

        function centerGPS() {
            if(userLat) map.flyTo([userLat, userLng], 16);
            else alert("Mencari sinyal...");
        }

        function getDist(lat1,lon1,lat2,lon2) { 
            var R=6371; var dLat=deg2rad(lat2-lat1); var dLon=deg2rad(lon2-lon1); 
            var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
        
        function bukaMenuMakaPlus() {
            Swal.fire({title:'Layanan Maka+', html:`<button onclick="aktifkanMaka()" style="background:#00f3ff; width:100%; padding:10px; border:none;">SAYA SUDAH PUNYA</button>`, showConfirmButton:false});
        }
        function aktifkanMaka(){ localStorage.setItem('makaLocal', true); location.reload(); }
        function logout(){ localStorage.clear(); location.reload(); }
    </script>
</body>
</html>

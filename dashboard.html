<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MLU Super App</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- GAYA DARI SCRIPT REFERENSI (MAKA FASTCHARGING) --- */
        :root {
            --bg: #050505; --card: #111; --card-border: #222;
            --accent: #CCFF00; --text: #ffffff; --text-mute: #888;
            --neon-blue: #00f3ff; /* Tambahan untuk dashboard */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; position: relative; }

        /* UTILS */
        .hidden { display: none !important; }
        .app-container { height: 100%; overflow-y: auto; padding-bottom: 80px; position: relative; z-index: 10; }

        /* LOGIN & REG (Gaya Lama dipertahankan krn sudah cocok) */
        #page-login, #page-register { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        input, select { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: #fff; border-radius: 10px; margin-bottom: 15px; outline: none; font-size: 16px; }
        .btn-main { width: 100%; padding: 15px; background: var(--neon-blue); color: #000; font-weight: 800; border: none; border-radius: 10px; font-size: 16px; text-transform: uppercase; }

        /* DASHBOARD (Gaya Cyberpunk) */
        .header { padding: 25px; background: linear-gradient(180deg, #111 0%, transparent 100%); display: flex; justify-content: space-between; align-items: center; }
        .vehicle-card { background: #111; border: 1px solid #333; margin: 20px; padding: 20px; border-radius: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; }
        .stat-box { background: #111; border: 1px solid #333; padding: 15px; border-radius: 15px; text-align: center; }
        .menu-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; text-align: center; font-size: 11px; color: #888; }
        .menu-icon { width: 50px; height: 50px; background: #222; border-radius: 15px; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: var(--neon-blue); }

        /* NAVBAR */
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 15px 0; z-index: 5000; }
        .nav-icon { font-size: 24px; color: #555; }
        .nav-icon.active { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }

        /* --- MAP SYSTEM (DARI SCRIPT REFERENSI) --- */
        #page-map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: #111; display: none; }
        #page-map.active { display: block !important; }
        #map { width: 100%; height: 100%; }
        
        /* OVERLAY BAWAH MAP */
        .map-overlay { 
            position: absolute; bottom: 90px; left: 15px; right: 15px; z-index: 1000; 
            background: rgba(20, 20, 20, 0.95); border: 1px solid #333;
            padding: 20px; border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            display: none; flex-direction: column; gap: 10px;
        }
        .map-title { font-family: 'Inter'; font-weight: 800; font-size: 1.2rem; color: #fff; margin: 0; }
        .map-subtitle { font-size: 0.9rem; color: #888; margin: 0; border-left: 3px solid var(--accent); padding-left: 10px; }
        .btn-gmaps-start { width: 100%; padding: 15px; background: var(--accent); color: #000; border: none; border-radius: 12px; font-weight: 800; text-transform: uppercase; cursor: pointer; }

        /* ICONS */
        .custom-icon { background: transparent; border: none; }
        /* Center Button */
        .btn-gps { position: absolute; bottom: 250px; right: 15px; width: 50px; height: 50px; background: #222; border: 1px solid #444; border-radius: 50%; z-index: 900; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; }
    </style>
</head>
<body>

    <div id="page-login">
        <h2 style="text-align:center; color:var(--neon-blue);">MEMBER ACCESS</h2>
        <input type="tel" id="inputHP" placeholder="Nomor HP">
        <button class="btn-main" onclick="handleLogin()">MASUK</button>
    </div>

    <div id="page-dashboard" class="hidden">
        <div class="app-container">
            <div class="header">
                <div><small style="color:#888">Hi,</small><h3 style="margin:0" id="disp-nama">User</h3></div>
                <button onclick="location.reload()" style="background:none; border:none; color:red;">Keluar</button>
            </div>
            <div class="vehicle-card">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-size:11px; color:#888;">TAGIHAN</span>
                    <span id="disp-tagihan" style="font-size:24px; font-weight:800; color:var(--neon-blue);">...</span>
                </div>
                <div style="margin-top:10px; color:#fff;">Unit: Maka Motors</div>
            </div>
            <div class="menu-list">
                <div><div class="menu-icon"><i class="fas fa-wallet"></i></div>Tagihan</div>
                <div><div class="menu-icon"><i class="fas fa-history"></i></div>Riwayat</div>
                <div><div class="menu-icon" style="color:red;"><i class="fas fa-exclamation-triangle"></i></div>SOS</div>
                <div><div class="menu-icon"><i class="fas fa-tools"></i></div>RTO</div>
            </div>
        </div>
        <div class="navbar">
            <div class="nav-icon active" onclick="showDash()"><i class="fas fa-home"></i></div>
            <div class="nav-icon" onclick="showMap()"><i class="fas fa-map-marked-alt"></i></div>
            <div class="nav-icon"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <div id="page-map">
        <div id="map"></div>
        <div class="btn-gps" onclick="centerMap()"><i class="fas fa-crosshairs"></i></div>
        
        <div id="map-panel" class="map-overlay">
            <h3 id="mapTitle" class="map-title">Nama Lokasi</h3>
            <p id="mapSub" class="map-subtitle">Jarak: -- KM</p>
            <a href="#" id="btnGmaps" target="_blank" style="text-decoration:none;">
                <button class="btn-gmaps-start">BUKA GOOGLE MAPS ↗</button>
            </a>
        </div>

        <div class="navbar">
            <div class="nav-icon" onclick="showDash()"><i class="fas fa-home"></i></div>
            <div class="nav-icon active" onclick="showMap()"><i class="fas fa-map-marked-alt"></i></div>
            <div class="nav-icon"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG DARI SHEET ANDA
        const CFG = {
            sheetID: '1kp7bHdgSTTNZF3uyd1ul-LnTZVjuLs1TVQnRxoViPfQ', 
            // INI URL CSV LOKASI DARI SCRIPT REFERENSI ANDA (DIJAMIN JALAN)
            urlLokasi: 'https://docs.google.com/spreadsheets/d/1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM/export?format=csv'
        };

        let map, userLat, userLng, userMarker;

        // --- LOGIN SYSTEM ---
        function handleLogin() {
            const hp = document.getElementById('inputHP').value;
            if(!hp) return alert("Isi Nomor");
            document.querySelector('#page-login button').innerText = "Loading...";
            
            const clean = hp.replace(/[^0-9]/g,'').replace(/^62/,'').replace(/^0/,'');
            
            fetch(`https://opensheet.elk.sh/${CFG.sheetID}/USER?t=${Date.now()}`).then(r=>r.json()).then(data=>{
                const user = data.find(u => String(u['No HP']).includes(clean));
                if(user) {
                    document.getElementById('disp-nama').innerText = user['Nama'];
                    document.getElementById('disp-tagihan').innerText = "Rp 70.000"; // Simplifikasi
                    document.getElementById('page-login').classList.add('hidden');
                    document.getElementById('page-dashboard').classList.remove('hidden');
                } else {
                    alert("Nomor tidak ditemukan");
                    document.querySelector('#page-login button').innerText = "MASUK";
                }
            });
        }

        // --- MAP SYSTEM (LOGIKA SCRIPT REFERENSI) ---
        function showDash() {
            document.getElementById('page-dashboard').classList.remove('hidden');
            document.getElementById('page-map').classList.remove('active');
        }

        function showMap() {
            document.getElementById('page-dashboard').classList.add('hidden');
            document.getElementById('page-map').classList.add('active');
            
            // RENDER PETA (PASTI MUNCUL)
            setTimeout(() => {
                if(!map) initMap();
                map.invalidateSize(); 
            }, 200);
        }

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([-6.2, 106.8], 12);
            
            // TILE DARK MATTER (Sesuai Referensi)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© MLU', maxZoom: 20
            }).addTo(map);

            // GPS User
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(p => {
                    userLat = p.coords.latitude; userLng = p.coords.longitude;
                    
                    // Marker User (Titik Hijau Neon)
                    if(!userMarker) {
                        const userIcon = L.divIcon({
                            className: 'custom-icon',
                            html: '<div style="width:15px;height:15px;background:#00f3ff;border-radius:50%;box-shadow:0 0 10px #00f3ff;border:2px solid #fff;"></div>',
                            iconSize: [15, 15]
                        });
                        userMarker = L.marker([userLat, userLng], {icon: userIcon}).addTo(map);
                        map.setView([userLat, userLng], 13);
                    } else {
                        userMarker.setLatLng([userLat, userLng]);
                    }
                });
            }

            // LOAD DATA DARI CSV LANGSUNG (Logic Referensi)
            fetch(CFG.urlLokasi).then(r=>r.text()).then(csvText => {
                const rows = csvText.split('\n').slice(1); // Skip header
                rows.forEach(row => {
                    const cols = row.split(',');
                    if(cols.length < 5) return;
                    
                    // Bersihkan Lat/Lng
                    let lat = parseFloat(cols[4].replace(',', '.'));
                    let lng = parseFloat(cols[5].replace(',', '.'));
                    let nama = cols[0];
                    let gmap = cols[6];

                    if(!isNaN(lat)) {
                        // Marker Petir Kuning
                        const iconFc = L.divIcon({
                            className: 'custom-icon',
                            html: '<div style="font-size:30px;color:#CCFF00;text-shadow:0 0 10px #CCFF00;">⚡</div>',
                            iconSize: [30, 30], iconAnchor: [10, 15]
                        });

                        let m = L.marker([lat, lng], {icon: iconFc}).addTo(map);
                        
                        m.on('click', () => {
                            document.getElementById('map-panel').style.display = 'flex';
                            document.getElementById('mapTitle').innerText = nama;
                            
                            if(userLat) {
                                let d = getDist(userLat, userLng, lat, lng);
                                document.getElementById('mapSub').innerText = `Jarak: ${d} km`;
                            }

                            let link = gmap && gmap.length > 5 ? gmap : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                            document.getElementById('btnGmaps').href = link;
                        });
                    }
                });
            });
        }

        function centerMap() { if(userLat) map.setView([userLat, userLng], 15); }
        
        function getDist(lat1, lon1, lat2, lon2) {
            const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);
        }
    </script>
</body>
</html>
